# My Winter Car Korean Localization - AI Instructions

## Project Context
**Game:** My Winter Car (Unity 5, PlayMaker FSM)  
**Framework:** BepInEx 5.x plugin system  
**Reference:** My Summer Car Korean translation (`ref/msc_kr_strings/`)  
**Current Phase:** Phase 1 - LanguageFramework (automatic UI translation)

# Translation Architecture

**Core Workflow:**
1. Load `translate.txt` with normalized keys (uppercase, no spaces)
2. Scan TextMesh components matching GameObject paths
3. Replace English → Korean if translation exists
4. Apply Korean-compatible fonts from AssetBundle
5. Monitor dynamic UI elements that appear after scene load

**Key Normalization:**
```csharp
// StringHelper.FormatUpperKey() removes spaces/newlines, converts uppercase
"BEER 149 MK" → "BEER149MK"
```

## Dynamic UI Monitoring System

### Critical Elements Requiring Continuous Monitoring
These elements are created AFTER scene load and need persistent tracking:

**Priority Elements (checked every frame):**
- `GUI/Indicators/Interaction` - Item interaction prompts
- `GUI/Indicators/Partname` - Item/part names  
- `GUI/Indicators/Subtitles` - NPC subtitles

**Regular Elements (throttled checking):**
- `GUI/HUD/*` - Player stats (hunger, thirst, stress, etc.)
- `Sheets/YellowPagesMagazine/Page*/Lines/YellowLine` - Magazine text

## Monitoring Architecture Decisions

**Translation State Tracking:**
- Use `Dictionary<TextMesh, string>` to track last translated text
- Only re-translate when text changes from cached value
- Prevents continuous re-translation loops

**Korean Character Detection:**
```csharp
StringHelper.ContainsKorean(text) // Checks Unicode ranges AC00-D7AF, 1100-11FF, 3130-318F
```
- Used to skip already-translated text
- Exception: Magazine text can be regenerated by game, needs persistent monitoring

**Priority vs Regular Monitoring:**
- Priority elements: Checked every frame (instant translation)
- Regular elements: Throttled to prevent performance issues
- Magazine text: Kept in monitoring even after Korean detected (game regenerates content)

## Complex Text Handling

**Magazine Random Text (comma-separated words):**
```csharp
// Example: "bucket, hydraulic, oil" → "양동이, 유압, 오일"
HandleComplexTextMesh() splits on ',' and translates each word individually
```

**Magazine Price Lines:**
```csharp
// Example: "h.149,- puh.123456" → "149 MK, 전화 - 123456"
Custom parsing for price + phone number format
```

## Known Issues & Solutions

### Issue: HUD Elements Reverting to English
**Cause:** Elements get reset by game but aren't re-translated quickly  
**Solution:** Use translation tracking - only re-translate when text actually changes

### Issue: Magazine Text Refreshing/Adding Spaces
**Cause:** Re-running complex text handler on already-translated Korean text  
**Solution:** 
- Option 1: Track handled TextMesh objects in HashSet
- Option 2: Use Korean detection + tracking (check if matches last translation)
- Keep magazine in monitoring (game regenerates on overlay reopen)

### Issue: Subtitle Translation Delay
**Cause:** Regular monitoring interval (1 second scan) too slow  
**Solution:** Priority monitoring system - check critical paths every frame

### Issue: Font Not Updating Properly
**Cause:** Font only applied on first translation, not on cached lookups  
**Solution:** ALWAYS apply font when translating, even for cached text
```csharp
// Update both font and material texture
textMesh.font = koreanFont;
renderer.material.mainTexture = koreanFont.material.mainTexture;
```

## Performance Optimization Strategies

**✅ Best Practices:**
- Cache TextMesh references, don't re-search scene
- Use `lastTranslatedText` dictionary to skip unchanged text
- Throttle non-priority elements (check subset per frame)
- Scan for new elements at intervals (1 second), not every frame

**❌ Anti-patterns:**
- Scanning all TextMesh objects every frame
- Re-translating already-Korean text repeatedly
- Removing Korean detection entirely (causes re-translation loops)
- Not tracking translation state

## Architecture Simplification Guidelines

When system becomes complex, consider:

1. **Single responsibility per method** - Separate scanning, translating, font application
2. **Unified monitoring list** - Avoid multiple overlapping lists (priority/dynamic/etc)
3. **Clear state tracking** - Know what was translated and when
4. **Path-based priority** - Simple path checks for priority determination
5. **Modular font application** - Extract to separate method for reuse

**Balance:** Simplicity vs functionality - Don't over-engineer, but handle edge cases

## Translation File Format (MSC Compatible)

```
// Comments use //
KEY = Korean Translation

// String normalization applied to keys
BEER149MK = 맥주 149 MK
BUCKET = 양동이
```

**CRITICAL:** Spaces around `=` required: `KEY = VALUE` not `KEY=VALUE`

## Quick Reference

### GameObject Paths for Monitoring
```
GUI/Indicators/Interaction       - Instant priority
GUI/Indicators/Partname          - Instant priority  
GUI/Indicators/Subtitles         - Instant priority
GUI/HUD/*                        - Regular throttled
Sheets/YellowPagesMagazine/*/Lines/YellowLine - Persistent monitoring
```

### Korean Font Application
```csharp
Font koreanFont = GetKoreanFont(originalFontName);
textMesh.font = koreanFont;
textMesh.GetComponent<MeshRenderer>().material.mainTexture = koreanFont.material.mainTexture;
```

### Position Adjustments
```csharp
// HUD labels: -0.05f downward
// ATM screens: +0.25f to +0.45f upward  
// Per-element basis in AdjustTextPosition()
```

## Development Workflow

1. **Extract strings** - Use F8 string dumper in-game
2. **Create translations** - Populate `translate.txt`  
3. **Test incrementally** - Small batches, verify in-game
4. **Monitor performance** - Check for re-translation loops
5. **Handle edge cases** - Add complex handlers as needed

---

**Last Updated:** January 1, 2026  
**Status:** Phase 1 active development - Dynamic monitoring refinement  
**Next:** Finalize monitoring architecture, begin Phase 2 planning
